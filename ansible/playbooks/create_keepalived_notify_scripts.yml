# ansible\playbooks\create_keepalived_notify_scripts.yml
---
- name: Crear scripts de notificación para Keepalived (MASTER / BACKUP / FAULT)
  hosts: haproxy_keepalived
  become: true
  gather_facts: false

  tasks:

    - name: 📁 Crear carpeta para scripts de Keepalived
      ansible.builtin.file:
        path: /etc/keepalived/scripts
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: 📜 Crear script vip_master.sh
      ansible.builtin.copy:
        dest: /etc/keepalived/scripts/vip_master.sh
        content: |
          #!/bin/bash
          LOGFILE="/var/log/keepalived_vip.log"
          mkdir -p "$(dirname $LOGFILE)"
          MSG="$(date '+%F %T') - [KEEPALIVED] $(hostname -s) - IP $(hostname -I | awk '{print $1}') asumió el rol MASTER para $1"
          echo "==============================" >> "$LOGFILE"
          echo "$MSG" >> "$LOGFILE"
          logger -t keepalived "$MSG"
        owner: root
        group: root
        mode: '0755'

    - name: 📜 Crear script vip_backup.sh
      ansible.builtin.copy:
        dest: /etc/keepalived/scripts/vip_backup.sh
        content: |
          #!/bin/bash
          LOGFILE="/var/log/keepalived_vip.log"
          mkdir -p "$(dirname $LOGFILE)"
          MSG="$(date '+%F %T') - [KEEPALIVED] $(hostname -s) - IP $(hostname -I | awk '{print $1}') cambió a BACKUP para $1"
          echo "==============================" >> "$LOGFILE"
          echo "$MSG" >> "$LOGFILE"
          logger -t keepalived "$MSG"
        owner: root
        group: root
        mode: '0755'

    - name: 📜 Crear script vip_fault.sh
      ansible.builtin.copy:
        dest: /etc/keepalived/scripts/vip_fault.sh
        content: |
          #!/bin/bash
          LOGFILE="/var/log/keepalived_vip.log"
          mkdir -p "$(dirname $LOGFILE)"
          MSG="$(date '+%F %T') - [KEEPALIVED] $(hostname -s) - IP $(hostname -I | awk '{print $1}') entró en estado FAULT para $1"
          echo "==============================" >> "$LOGFILE"
          echo "$MSG" >> "$LOGFILE"
          logger -t keepalived "$MSG"
        owner: root
        group: root
        mode: '0755'

    - name: ✅ Verificar existencia de scripts creados
      ansible.builtin.shell: ls -l /etc/keepalived/scripts/
      register: script_check
      changed_when: false

    - name: 📋 Mostrar scripts generados
      ansible.builtin.debug:
        var: script_check.stdout_lines